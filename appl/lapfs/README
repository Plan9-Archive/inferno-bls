lapfs - A Laptop File System

N.B.  This isn't a man page yet because it's not yet mature
enough.

This is the file system described in the WIP paper for IWP9
"A File System for Laptops."  Since the workshop, it's gotten
to the point where I can use it on a regular basis, but it's
still not complete.  In particular the current issues include:

- The write buffer/playback for modifications when disconnected
has had VERY little testing.  Use at your own risk.
- The playback process currently doesn't detect or do anything
about conflicts.  That'll come along a little later.
- There's no optimization on playback, so almost every Styx
message is played as it was originally recieved.
- When disconnected, the permissions on files will not be entirely
correct.  All files in the cache are created with owner write
permission on so that they can be written to from the server.
So if a file is 444 on the server, it'll look like 644 when disconnected.
- I've seen some crashes, especially with very large files that
I still haven't really tracked down, so be forewarned.  Doing
a wc on a 52MB file might crash after about 4 or 5 MB.

Both the conflicts and permissions reporting will be addressed
with a set of shadow metadata, but that hasn't been implemented
yet.

I've got a very preliminary picture of performance.  In one test,
wc went from 1.7MB/s using p9p to a Plan 9 file server to 1.1MB/s
going to the same file server through lapfs.  It's a noticable penalty,
but it's a whole lot better than the old version.

So here's how to use it:

- To enable the playback mechanism, create a file called
wblog in the directory where you'll be running it.  (When
the playback is more debugged, I'll have it create the file
if it's not there and will probably put it in /lib.)
- You run it with:

lapfs [-d] cache [server]

The -d option turns on debugging output.

Both the cache and server can take several different forms.
  1: If it starts with "/chan" it's directly opened as the Sys->FD
     to that server.
  2: If it contains a "!" it's opened with sys->dial to get the
     Sys->FD.
  3: If it starts with "#" or "/" a pipe is created and sys->export
     is used to establish a Sys->FD.
If the server is omitted or it's a network address than can't be
opened, then lapfs goes into a cache-only, disconnected mode
where everything is done with the cache and most transactions
are recorded to wblog.

lapfs then listens on port 1962 for connections from its client.
So in emu when connected to the network:

lapfs '#U*/home/stuart/.bootescache' 'tcp!172.30.1.2!6666'

where 172.30.1.2 is the address of the file server and it's listening
on 6666 for an unauthenticated connection.  Then in the host OS,

9 mount 'tcp!127.1!1962' /home/stuart/fs

mounts it, and the server is available at /home/stuart/fs with
the cache being kept in /home/stuart/.bootescache.

